<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ - EventHub</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <a href="/index.html" class="logo">
                <svg class="logo-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span>EventHub</span>
            </a>
            
            <nav>
                <a href="/index.html">Trang chủ</a>
                <a href="/pages/events.html">Sự kiện</a>
                <div id="user-menu" class="user-menu" style="display: none;">
                    <span class="user-balance">0 đ</span>
                    <a href="/pages/wallet.html" class="btn btn-secondary">Ví</a>
                    <a href="/pages/profile.html" class="user-name">User</a>
                    <img id="user-avatar" class="user-avatar" src="" alt="Avatar" style="display: none;" onclick="window.location.href='/pages/profile.html'">
                    <button onclick="handleLogout()" class="btn btn-danger">Đăng xuất</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="container" style="padding: 2rem 1rem; max-width: 800px;">
        <h1 style="font-size: 2rem; font-weight: bold; margin-bottom: 2rem;">Hồ sơ của tôi</h1>

        <div class="card" style="margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Thông tin cá nhân</h2>
            <form id="profile-form" onsubmit="handleUpdateProfile(event)">
                <div class="grid grid-2" style="gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Họ và tên</label>
                        <input type="text" id="fullName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="email" class="form-input" required>
                    </div>
                </div>

                <div class="grid grid-2" style="gap: 1rem; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Số điện thoại</label>
                        <input type="tel" id="phone" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Giới tính</label>
                        <select id="sex" class="form-input">
                            <option value="">Chọn giới tính</option>
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Địa chỉ</label>
                    <input type="text" id="address" class="form-input">
                </div>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Ngày sinh</label>
                    <input type="date" id="birthday" class="form-input">
                </div>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Ảnh đại diện</label>
                    <input type="file" id="avatar" accept="image/*" class="form-input">
                    <div id="avatar-preview" style="margin-top: 0.5rem;"></div>
                </div>

                <button type="submit" class="btn btn-primary">Cập nhật thông tin</button>
            </form>
        </div>

        <div class="card">
            <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Đổi mật khẩu</h2>
            <form id="password-form" onsubmit="handleChangePassword(event)">
                <div class="form-group">
                    <label class="form-label">Mật khẩu hiện tại</label>
                    <input type="password" id="oldPassword" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Mật khẩu mới</label>
                    <input type="password" id="newPassword" class="form-input" required minlength="6">
                </div>

                <div class="form-group">
                    <label class="form-label">Xác nhận mật khẩu mới</label>
                    <input type="password" id="confirmPassword" class="form-input" required>
                </div>

                <button type="submit" class="btn btn-primary">Đổi mật khẩu</button>
            </form>
        </div>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!requireAuth()) return;
            initAuth();
            
            loadUserProfile();
            
            // Avatar preview
            document.getElementById('avatar').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('avatar-preview').innerHTML = `
                            <img src="${e.target.result}" alt="Avatar preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 2px solid var(--gray-200);">
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        async function loadUserProfile() {
            const user = getCurrentUser();
            if (!user) return;

            document.getElementById('fullName').value = user.FullName || '';
            document.getElementById('email').value = user.Gmail || '';
            document.getElementById('phone').value = user.Phone || '';
            document.getElementById('address').value = user.Address || '';
            document.getElementById('birthday').value = user.Birthday || '';
            document.getElementById('sex').value = user.Sex || '';

            if (user.Avatar_URL) {
                document.getElementById('avatar-preview').innerHTML = `
                    <img src="${user.Avatar_URL}" alt="Avatar" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 2px solid var(--gray-200);">
                `;
            }
        }

        async function handleUpdateProfile(event) {
            event.preventDefault();
            
            const user = getCurrentUser();
            if (!user) return;

            const formData = {
                FullName: document.getElementById('fullName').value,
                Gmail: document.getElementById('email').value,
                Phone: document.getElementById('phone').value,
                Address: document.getElementById('address').value,
                Birthday: document.getElementById('birthday').value,
                Sex: document.getElementById('sex').value,
            };

            const avatarFile = document.getElementById('avatar').files[0];
            if (avatarFile) {
                formData.avatar = avatarFile;
            }

            try {
                const updatedUser = await API.updateUser(user.User_ID, formData);
                setCurrentUser(updatedUser, localStorage.getItem('token'));
                showToast('Cập nhật thông tin thành công!', 'success');
                loadUserProfile();
            } catch (error) {
                showToast(error.message || 'Cập nhật thất bại', 'error');
            }
        }

        async function handleChangePassword(event) {
            event.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showToast('Mật khẩu xác nhận không khớp', 'error');
                return;
            }

            if (!validatePassword(newPassword)) {
                showToast('Mật khẩu phải có ít nhất 6 ký tự', 'error');
                return;
            }

            try {
                await API.changePassword(oldPassword, newPassword);
                showToast('Đổi mật khẩu thành công!', 'success');
                event.target.reset();
            } catch (error) {
                showToast(error.message || 'Đổi mật khẩu thất bại', 'error');
            }
        }
    </script>
</body>
</html>

