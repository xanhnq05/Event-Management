<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mua v√© - EventHub</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <a href="/index.html" class="logo">
                <svg class="logo-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span>EventHub</span>
            </a>
            
            <nav>
                <a href="/index.html">Trang ch·ªß</a>
                <a href="/pages/events.html">S·ª± ki·ªán</a>
                <div id="user-menu" class="user-menu" style="display: none;">
                    <span class="user-balance">0 ƒë</span>
                    <a href="/pages/wallet.html" class="btn btn-secondary">V√≠</a>
                    <a href="/pages/profile.html" class="user-name">User</a>
                    <img id="user-avatar" class="user-avatar" src="" alt="Avatar" style="display: none;" onclick="window.location.href='/pages/profile.html'">
                    <button onclick="handleLogout()" class="btn btn-danger">ƒêƒÉng xu·∫•t</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="container" style="padding: 2rem 1rem; max-width: 1000px;">
        <a href="javascript:history.back()" style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--gray-600); margin-bottom: 1.5rem; text-decoration: none;">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            <span>Quay l·∫°i</span>
        </a>

        <div id="buy-ticket-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>ƒêang t·∫£i th√¥ng tin...</p>
            </div>
        </div>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/payment.js"></script>
    <script>
        let event = null;
        let selectedTickets = {};

        document.addEventListener('DOMContentLoaded', () => {
            if (!requireAuth()) return;
            initAuth();
            
            const eventId = getUrlParameter('id');
            if (eventId) {
                loadEventForBuy(eventId);
            } else {
                showToast('Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán', 'error');
                window.location.href = '/pages/events.html';
            }
        });

        async function loadEventForBuy(eventId) {
            try {
                console.log('üì§ ƒêang t·∫£i th√¥ng tin s·ª± ki·ªán:', eventId);
                const response = await API.getEventById(eventId);
                console.log('üì• Response nh·∫≠n ƒë∆∞·ª£c:', response);
                
                // Handle different response structures
                if (response?.data) {
                    event = response.data;
                } else if (response && typeof response === 'object' && !Array.isArray(response)) {
                    event = response;
                } else {
                    throw new Error('Invalid event data');
                }
                
                console.log('‚úÖ Event data:', event);
                
                // Ensure Price_Ticket is a number
                if (event.Price_Ticket) {
                    event.Price_Ticket = parseFloat(event.Price_Ticket);
                }
                
                // Ensure Quantity is a number
                if (event.Quantity) {
                    event.Quantity = parseInt(event.Quantity);
                }
                
                displayBuyTicketForm();
            } catch (error) {
                console.error('‚ùå L·ªói khi t·∫£i s·ª± ki·ªán:', error);
                showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin s·ª± ki·ªán', 'error');
            }
        }

        function displayBuyTicketForm() {
            const container = document.getElementById('buy-ticket-container');
            if (!container || !event) {
                console.error('‚ùå Container ho·∫∑c event kh√¥ng t·ªìn t·∫°i');
                return;
            }

            console.log('üìã Displaying buy ticket form for event:', event);

            // Ensure we have valid price and quantity
            const price = parseFloat(event.Price_Ticket) || 0;
            const quantity = parseInt(event.Quantity) || 0;

            // Create default ticket if none exist
            const tickets = event.Tickets || [{
                Ticket_ID: `T${event.Event_ID}`,
                Ticket_Name: `V√© ${event.Event_Name || 'Ti√™u chu·∫©n'}`,
                Event_ID: event.Event_ID,
                Price: price,
            }];

            container.innerHTML = `
                <div class="grid grid-1 lg:grid-3" style="gap: 2rem;">
                    <div style="grid-column: span 2;">
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">${event.Event_Name}</h1>
                            ${event.Image_URL ? `
                            <img src="${getImageUrl(event.Image_URL)}" alt="${event.Event_Name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 1rem;">
                            ` : ''}
                            <p style="color: var(--gray-600);">${event.Description || ''}</p>
                        </div>

                        <div class="card">
                            <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Ch·ªçn s·ªë l∆∞·ª£ng v√©</h2>
                            
                            ${tickets.length === 0 ? `
                            <p class="text-center" style="padding: 2rem; color: var(--gray-500);">Kh√¥ng c√≥ v√© n√†o</p>
                            ` : `
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                ${tickets.map(ticket => `
                                <div style="border: 1px solid var(--gray-200); border-radius: 0.5rem; padding: 1rem; display: flex; align-items: center; justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--primary-color);">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                                        </svg>
                                        <div>
                                            <p style="font-weight: 600;">${ticket.Ticket_Name || 'V√© ti√™u chu·∫©n'}</p>
                                            <p style="font-size: 0.875rem; color: var(--gray-600);">${formatCurrency(ticket.Price || event.Price_Ticket || 0)} / v√©</p>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <button onclick="changeQuantity('${ticket.Ticket_ID}', -1)" class="btn btn-secondary" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;" id="btn-minus-${ticket.Ticket_ID}">-</button>
                                        <span id="quantity-${ticket.Ticket_ID}" style="width: 48px; text-align: center; font-weight: 600;">0</span>
                                        <button onclick="changeQuantity('${ticket.Ticket_ID}', 1)" class="btn btn-secondary" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;" id="btn-plus-${ticket.Ticket_ID}">+</button>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                    </div>

                    <div>
                        <div class="card" style="position: sticky; top: 100px;">
                            <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">T√≥m t·∫Øt ƒë∆°n h√†ng</h2>
                            <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--gray-600);">S·ªë l∆∞·ª£ng v√©:</span>
                                    <span style="font-weight: 600;" id="total-quantity">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--gray-600);">Gi√° m·ªói v√©:</span>
                                    <span style="font-weight: 600;">${formatCurrency(event.Price_Ticket || 0)}</span>
                                </div>
                                <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem;">
                                    <div style="display: flex; justify-content: space-between; font-size: 1.125rem;">
                                        <span style="font-weight: bold;">T·ªïng c·ªông:</span>
                                        <span style="font-weight: bold; color: var(--primary-color);" id="total-price">${formatCurrency(0)}</span>
                                    </div>
                                </div>
                            </div>

                            <button onclick="handleCheckout()" class="btn btn-primary" style="width: 100%;" id="checkout-btn" disabled>
                                Thanh to√°n
                            </button>

                            <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 1rem; text-align: center;">
                                B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c m√£ OTP qua email ƒë·ªÉ x√°c nh·∫≠n thanh to√°n
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function changeQuantity(ticketId, delta) {
            const currentQty = selectedTickets[ticketId] || 0;
            const maxQty = parseInt(event.Quantity) || 0;
            const newQty = Math.max(0, Math.min(currentQty + delta, maxQty));
            
            selectedTickets[ticketId] = newQty;
            
            // Update UI
            const qtyElement = document.getElementById(`quantity-${ticketId}`);
            const minusBtn = document.getElementById(`btn-minus-${ticketId}`);
            const plusBtn = document.getElementById(`btn-plus-${ticketId}`);
            
            if (qtyElement) qtyElement.textContent = newQty;
            if (minusBtn) minusBtn.disabled = newQty === 0;
            if (plusBtn) plusBtn.disabled = newQty >= maxQty;
            
            updateSummary();
        }

        function updateSummary() {
            if (!event) return;
            
            const totalQty = Object.values(selectedTickets).reduce((sum, qty) => sum + qty, 0);
            const pricePerTicket = parseFloat(event.Price_Ticket) || 0;
            const totalPrice = totalQty * pricePerTicket;
            
            const qtyElement = document.getElementById('total-quantity');
            const priceElement = document.getElementById('total-price');
            const checkoutBtn = document.getElementById('checkout-btn');
            
            if (qtyElement) qtyElement.textContent = totalQty;
            if (priceElement) priceElement.textContent = formatCurrency(totalPrice);
            if (checkoutBtn) checkoutBtn.disabled = totalQty === 0;
        }

        async function handleCheckout() {
            const totalQty = Object.values(selectedTickets).reduce((sum, qty) => sum + qty, 0);
            if (totalQty === 0) {
                showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 v√©', 'error');
                return;
            }

            const user = getCurrentUser();
            if (!user || !user.Gmail) {
                showToast('Kh√¥ng t√¨m th·∫•y th√¥ng tin email', 'error');
                return;
            }

            // Check balance before proceeding
            const totalAmount = totalQty * (parseFloat(event.Price_Ticket) || 0);
            const userBalance = parseFloat(user.Amount || 0);
            
            if (userBalance < totalAmount) {
                showToast(`S·ªë d∆∞ kh√¥ng ƒë·ªß. B·∫°n c·∫ßn ${formatCurrency(totalAmount)} nh∆∞ng ch·ªâ c√≥ ${formatCurrency(userBalance)}. Vui l√≤ng n·∫°p th√™m ti·ªÅn v√†o v√≠.`, 'error');
                return;
            }

            const btn = document.getElementById('checkout-btn');
            btn.disabled = true;
            btn.textContent = 'ƒêang x·ª≠ l√Ω...';

            try {
                // Step 1: Send OTP to user's email
                showToast('ƒêang g·ª≠i m√£ OTP ƒë·∫øn email c·ªßa b·∫°n...', 'success');
                await API.sendOTP(user.Gmail, 'email');
                
                // Step 2: Create payment session
                console.log('üì§ Creating payment session with:', {
                    eventId: event.Event_ID,
                    event: event,
                    selectedTickets: selectedTickets,
                    totalQty: totalQty
                });
                
                if (!event || !event.Event_ID) {
                    throw new Error('Th√¥ng tin s·ª± ki·ªán kh√¥ng h·ª£p l·ªá. Vui l√≤ng t·∫£i l·∫°i trang.');
                }
                
                const session = await createPaymentSession(event.Event_ID, selectedTickets);
                console.log('‚úÖ Payment session created:', session);
                
                const sessionId = session?.session_id || session?.sessionId;
                if (!sessionId) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫°o phi√™n thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.');
                }
                
                // Step 3: Store session data and redirect to payment page
                sessionStorage.setItem(`payment_${sessionId}`, JSON.stringify({
                    amount: totalAmount,
                    eventId: event.Event_ID,
                    ticketQuantities: selectedTickets
                }));
                
                console.log('üîó Redirecting to payment page with sessionId:', sessionId);
                window.location.href = `/pages/payment.html?sessionId=${sessionId}`;
            } catch (error) {
                console.error('Checkout error:', error);
                showToast(error.message || 'C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω thanh to√°n', 'error');
                btn.disabled = false;
                btn.textContent = 'Thanh to√°n';
            }
        }
    </script>
</body>
</html>

