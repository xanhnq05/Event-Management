<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mua vé - EventHub</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <a href="/index.html" class="logo">
                <svg class="logo-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span>EventHub</span>
            </a>
            
            <nav>
                <a href="/index.html">Trang chủ</a>
                <a href="/pages/events.html">Sự kiện</a>
                <div id="user-menu" class="user-menu" style="display: none;">
                    <span class="user-balance">0 đ</span>
                    <a href="/pages/wallet.html" class="btn btn-secondary">Ví</a>
                    <a href="/pages/profile.html" class="user-name">User</a>
                    <button onclick="handleLogout()" class="btn btn-danger">Đăng xuất</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="container" style="padding: 2rem 1rem; max-width: 1000px;">
        <a href="javascript:history.back()" style="display: inline-flex; align-items: center; gap: 0.5rem; color: var(--gray-600); margin-bottom: 1.5rem; text-decoration: none;">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            <span>Quay lại</span>
        </a>

        <div id="buy-ticket-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>Đang tải thông tin...</p>
            </div>
        </div>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/payment.js"></script>
    <script>
        let event = null;
        let selectedTickets = {};

        document.addEventListener('DOMContentLoaded', () => {
            if (!requireAuth()) return;
            initAuth();
            
            const eventId = getUrlParameter('id');
            if (eventId) {
                loadEventForBuy(eventId);
            } else {
                showToast('Không tìm thấy sự kiện', 'error');
                window.location.href = '/pages/events.html';
            }
        });

        async function loadEventForBuy(eventId) {
            try {
                event = await API.getEventById(eventId);
                displayBuyTicketForm();
            } catch (error) {
                showToast('Không thể tải thông tin sự kiện', 'error');
                console.error(error);
            }
        }

        function displayBuyTicketForm() {
            const container = document.getElementById('buy-ticket-container');
            if (!container || !event) return;

            // Create default ticket if none exist
            const tickets = event.Tickets || [{
                Ticket_ID: `T${event.Event_ID}`,
                Ticket_Name: `Vé ${event.Event_Name}`,
                Event_ID: event.Event_ID,
            }];

            container.innerHTML = `
                <div class="grid grid-1 lg:grid-3" style="gap: 2rem;">
                    <div style="grid-column: span 2;">
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">${event.Event_Name}</h1>
                            ${event.Image_URL ? `
                            <img src="${event.Image_URL}" alt="${event.Event_Name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 1rem;">
                            ` : ''}
                            <p style="color: var(--gray-600);">${event.Description || ''}</p>
                        </div>

                        <div class="card">
                            <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Chọn số lượng vé</h2>
                            
                            ${tickets.length === 0 ? `
                            <p class="text-center" style="padding: 2rem; color: var(--gray-500);">Không có vé nào</p>
                            ` : `
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                ${tickets.map(ticket => `
                                <div style="border: 1px solid var(--gray-200); border-radius: 0.5rem; padding: 1rem; display: flex; align-items: center; justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: var(--primary-color);">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                                        </svg>
                                        <div>
                                            <p style="font-weight: 600;">${ticket.Ticket_Name || 'Vé tiêu chuẩn'}</p>
                                            <p style="font-size: 0.875rem; color: var(--gray-600);">${formatCurrency(event.Price_Ticket)} / vé</p>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <button onclick="changeQuantity('${ticket.Ticket_ID}', -1)" class="btn btn-secondary" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;" id="btn-minus-${ticket.Ticket_ID}">-</button>
                                        <span id="quantity-${ticket.Ticket_ID}" style="width: 48px; text-align: center; font-weight: 600;">0</span>
                                        <button onclick="changeQuantity('${ticket.Ticket_ID}', 1)" class="btn btn-secondary" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;" id="btn-plus-${ticket.Ticket_ID}">+</button>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                            `}
                        </div>
                    </div>

                    <div>
                        <div class="card" style="position: sticky; top: 100px;">
                            <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">Tóm tắt đơn hàng</h2>
                            <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--gray-600);">Số lượng vé:</span>
                                    <span style="font-weight: 600;" id="total-quantity">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--gray-600);">Giá mỗi vé:</span>
                                    <span style="font-weight: 600;">${formatCurrency(event.Price_Ticket)}</span>
                                </div>
                                <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem;">
                                    <div style="display: flex; justify-content: space-between; font-size: 1.125rem;">
                                        <span style="font-weight: bold;">Tổng cộng:</span>
                                        <span style="font-weight: bold; color: var(--primary-color);" id="total-price">${formatCurrency(0)}</span>
                                    </div>
                                </div>
                            </div>

                            <button onclick="handleCheckout()" class="btn btn-primary" style="width: 100%;" id="checkout-btn" disabled>
                                Thanh toán
                            </button>

                            <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 1rem; text-align: center;">
                                Bạn sẽ nhận được mã OTP qua email để xác nhận thanh toán
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function changeQuantity(ticketId, delta) {
            const currentQty = selectedTickets[ticketId] || 0;
            const newQty = Math.max(0, Math.min(currentQty + delta, event.Quantity));
            
            selectedTickets[ticketId] = newQty;
            
            // Update UI
            document.getElementById(`quantity-${ticketId}`).textContent = newQty;
            document.getElementById(`btn-minus-${ticketId}`).disabled = newQty === 0;
            document.getElementById(`btn-plus-${ticketId}`).disabled = newQty >= event.Quantity;
            
            updateSummary();
        }

        function updateSummary() {
            const totalQty = Object.values(selectedTickets).reduce((sum, qty) => sum + qty, 0);
            const totalPrice = totalQty * event.Price_Ticket;
            
            document.getElementById('total-quantity').textContent = totalQty;
            document.getElementById('total-price').textContent = formatCurrency(totalPrice);
            document.getElementById('checkout-btn').disabled = totalQty === 0;
        }

        async function handleCheckout() {
            const totalQty = Object.values(selectedTickets).reduce((sum, qty) => sum + qty, 0);
            if (totalQty === 0) {
                showToast('Vui lòng chọn ít nhất 1 vé', 'error');
                return;
            }

            try {
                const session = await createPaymentSession(event.Event_ID, selectedTickets);
                window.location.href = `/pages/payment.html?sessionId=${session.session_id}`;
            } catch (error) {
                console.error('Checkout error:', error);
            }
        }
    </script>
</body>
</html>

